<?php

namespace Database\Seeders;

use App\Models\Comment;
use App\Models\Course;
use App\Models\Lesson;
use App\Models\User;
use Illuminate\Database\Seeder;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Schema;

class CommentSeeder extends Seeder
{
    /**
     * Run the database seeds.
     */
    public function run(): void
    {
        // ========================================
        // 1. ุงูุชุญูู ูู ูุฌูุฏ ุงูุฌุฏุงูู ุงููุทููุจุฉ
        // ========================================
        $this->command->info('๐ ุฌุงุฑู ุงูุชุญูู ูู ูุฌูุฏ ุงูุฌุฏุงูู ุงููุทููุจุฉ...');

        $requiredTables = ['users', 'courses', 'lessons'];
        foreach ($requiredTables as $table) {
            if (! Schema::hasTable($table)) {
                $this->command->error("โ ุงูุฌุฏูู '{$table}' ุบูุฑ ููุฌูุฏ!");
                $this->command->comment('๐ก ูุฑุฌู ุชุดุบูู: php artisan migrate');

                return;
            }
        }

        // ========================================
        // 2. ุงูุชุญูู ูู ูุฌูุฏ ุจูุงูุงุช ุฃุณุงุณูุฉ
        // ========================================
        $this->command->info('๐ ุฌุงุฑู ุงูุชุญูู ูู ูุฌูุฏ ุงูุจูุงูุงุช ุงูุฃุณุงุณูุฉ...');

        // ุงููุณุชุฎุฏููู
        if (User::count() === 0) {
            $this->command->warn('โ๏ธ ูุง ููุฌุฏ ูุณุชุฎุฏููู! ุณูุชู ุฅูุดุงุก ูุณุชุฎุฏููู ุชุฌุฑูุจููู...');
            $this->call(UserSeeder::class);
        }

        // ุงูุฏูุฑุงุช
        if (Course::count() === 0) {
            $this->command->warn('โ๏ธ ูุง ููุฌุฏ ุฏูุฑุงุช! ุณูุชู ุฅูุดุงุก ุฏูุฑุงุช ุชุฌุฑูุจูุฉ...');
            $this->call(CourseSeeder::class);
        }

        // ุงูุฏุฑูุณ
        if (Lesson::count() === 0) {
            $this->command->warn('โ๏ธ ูุง ููุฌุฏ ุฏุฑูุณ! ุณูุชู ุฅูุดุงุก ุฏุฑูุณ ุชุฌุฑูุจูุฉ...');
            $this->call(LessonSeeder::class);
        }

        // ========================================
        // 3. ุฌูุจ ุงูุจูุงูุงุช ุงูุฌุงูุฒุฉ
        // ========================================
        $users = User::where('admin_level', 0)->get();
        $lessons = Lesson::with('course')->get();

        if ($users->isEmpty()) {
            $this->command->error('โ ูุง ุชูุฌุฏ ูุณุชุฎุฏููู ุนุงุฏููู (ุบูุฑ ุฃุฏููู) ูุฅูุดุงุก ุชุนูููุงุช ููู!');
            $this->command->comment('๐ก ุชุฃูุฏ ูู ูุฌูุฏ ูุณุชุฎุฏููู ุจู admin_level = 0');

            return;
        }

        if ($lessons->isEmpty()) {
            $this->command->error('โ ูุง ุชูุฌุฏ ุฏุฑูุณ ูุฅุถุงูุฉ ุชุนูููุงุช ุนูููุง!');
            $this->command->comment('๐ก ุชุฃูุฏ ูู ุชุดุบูู LessonSeeder ุฃููุงู');

            return;
        }

        $this->command->info('โ ุชู ุงูุนุซูุฑ ุนูู:');
        $this->command->info("   - {$users->count()} ูุณุชุฎุฏู ุนุงุฏู");
        $this->command->info("   - {$lessons->count()} ุฏุฑุณ");
        $this->command->info("   - {$lessons->unique('course_id')->count()} ุฏูุฑุฉ");

        // ========================================
        // 4. ุญุฐู ุงูุชุนูููุงุช ุงูุญุงููุฉ (ูุชุฌูุจ ุงูุชูุฑุงุฑ)
        // ========================================
        $existingComments = Comment::count();
        if ($existingComments > 0) {
            $this->command->warn("โ๏ธ ููุฌุฏ {$existingComments} ุชุนููู ุณุงุจู. ุณูุชู ุญุฐููู ูุฅุนุงุฏุฉ ุงูุฅูุดุงุก...");
            DB::table('comments')->truncate();
        }

        // ========================================
        // 5. ุฅูุดุงุก ุงูุชุนูููุงุช ุงูุฑุฆูุณูุฉ
        // ========================================
        $this->command->info('๐ ุฌุงุฑู ุฅูุดุงุก ุงูุชุนูููุงุช ุงูุฑุฆูุณูุฉ...');

        $mainComments = [];
        $totalMain = 0;

        foreach ($lessons as $lesson) {
            // 3-6 ุชุนูููุงุช ุฑุฆูุณูุฉ ููู ุฏุฑุณ (ุญุณุจ ูุณุชูู ุงูุฏูุฑุฉ)
            $commentCount = match ($lesson->course->level) {
                'ูุจุชุฏุฆ' => rand(4, 7),
                'ูุชูุณุท' => rand(3, 5),
                'ูุชูุฏู' => rand(2, 4),
                default => rand(3, 6)
            };

            for ($i = 0; $i < $commentCount; $i++) {
                $mainComments[] = [
                    'user_id' => $users->random()->id,
                    'lesson_id' => $lesson->id,
                    'parent_id' => null,
                    'body' => $this->generateRealisticArabicComment($lesson),
                    'created_at' => now()->subMinutes(rand(1, 1440 * 30)), // ุญุชู 30 ููู ูุถู
                    'updated_at' => now()->subMinutes(rand(1, 1440 * 30)),
                ];
                $totalMain++;
            }
        }

        // ุฅุฏุฎุงู ุฏูุนู ูุชุญุณูู ุงูุฃุฏุงุก
        DB::table('comments')->insert($mainComments);
        $this->command->info("โ ุชู ุฅูุดุงุก {$totalMain} ุชุนููู ุฑุฆูุณู.");

        // ========================================
        // 6. ุฅูุดุงุก ุงูุฑุฏูุฏ ุนูู ุงูุชุนูููุงุช
        // ========================================
        $this->command->info('๐ฌ ุฌุงุฑู ุฅูุดุงุก ุงูุฑุฏูุฏ ุนูู ุงูุชุนูููุงุช...');

        $parentComments = Comment::whereNull('parent_id')->get();
        $replies = [];
        $totalReplies = 0;

        foreach ($parentComments as $parent) {
            // 0-4 ุฑุฏูุฏ ููู ุชุนููู ุฑุฆูุณู
            $replyCount = rand(0, 4);

            for ($i = 0; $i < $replyCount; $i++) {
                $replies[] = [
                    'user_id' => $users->random()->id,
                    'lesson_id' => $parent->lesson_id,
                    'parent_id' => $parent->id,
                    'body' => $this->generateRealisticArabicReply($parent),
                    'created_at' => $parent->created_at->addMinutes(rand(5, 180)),
                    'updated_at' => $parent->created_at->addMinutes(rand(5, 180)),
                ];
                $totalReplies++;
            }
        }

        // ุฅุฏุฎุงู ุงูุฑุฏูุฏ
        if (! empty($replies)) {
            DB::table('comments')->insert($replies);
            $this->command->info("โ ุชู ุฅูุดุงุก {$totalReplies} ุฑุฏ ุนูู ุงูุชุนูููุงุช.");
        } else {
            $this->command->warn('โ๏ธ ูู ูุชู ุฅูุดุงุก ุฃู ุฑุฏูุฏ (ุชู ุงุฎุชูุงุฑ 0 ุฑุฏูุฏ ุนุดูุงุฆูุงู)');
        }

        // ========================================
        // 7. ุนุฑุถ ุงูุฅุญุตุงุฆูุงุช ุงูููุงุฆูุฉ
        // ========================================
        $total = Comment::count();
        $main = Comment::whereNull('parent_id')->count();
        $repliesCount = Comment::whereNotNull('parent_id')->count();

        $this->command->info("\n๐ ุชู ุงูุงูุชูุงุก ุจูุฌุงุญ!");
        $this->command->info('========================================');
        $this->command->info('๐ ุฅุญุตุงุฆูุงุช ุงูุชุนูููุงุช:');
        $this->command->info("   - ุงููุฌููุน ุงูููู: {$total}");
        $this->command->info("   - ุชุนูููุงุช ุฑุฆูุณูุฉ: {$main}");
        $this->command->info("   - ุฑุฏูุฏ: {$repliesCount}");
        $this->command->info('========================================');

        // ========================================
        // 8. ุชูุตูู ุญุณุจ ุงูุฏูุฑุงุช (ุจุฏูู ุฎุทุฃ GROUP BY)
        // ========================================
        $this->command->info("\n๐ ุฃูุซุฑ 5 ุฏูุฑุงุช ุชุนูููุงุช:");

        // ุงูุทุฑููุฉ ุงูุตุญูุญุฉ ุงููุชูุงููุฉ ูุน only_full_group_by
        $courseStats = \DB::table('lessons')
            ->join('comments', 'lessons.id', '=', 'comments.lesson_id')
            ->join('courses', 'lessons.course_id', '=', 'courses.id')
            ->select(
                'courses.id',
                'courses.name_ar',
                \DB::raw('COUNT(comments.id) as total_comments')
            )
            ->groupBy('courses.id', 'courses.name_ar')
            ->orderByDesc('total_comments')
            ->limit(5)
            ->get();

        if ($courseStats->isEmpty()) {
            $this->command->warn('   โ๏ธ ูุง ุชูุฌุฏ ุชุนูููุงุช ุนูู ุฃู ุฏูุฑุฉ ุจุนุฏ.');
        } else {
            foreach ($courseStats as $index => $stat) {
                $this->command->info('   '.($index + 1).". {$stat->name_ar}: {$stat->total_comments} ุชุนููู");
            }
        }
        $this->updateCourseDurations();
    }

    private function updateCourseDurations(): void
    {
        $courses = \App\Models\Course::all();

        foreach ($courses as $course) {
            // ุญุณุงุจ ูุฌููุน ูุฏุฉ ุงูุฏุฑูุณ ุจุงูุฏูุงุฆู
            $totalMinutes = \App\Models\Lesson::where('course_id', $course->id)
                ->sum('duration_minutes');

            // ุชุญููู ุงูุฏูุงุฆู ุฅูู ุณุงุนุงุช (ุฏูุฉ 2 ุฃุฑูุงู ุนุดุฑูุฉ)
            $totalHours = round($totalMinutes / 60, 2);

            // ุชุญุฏูุซ ุงูุฏูุฑุฉ
            $course->update([
                'duration_hours' => $totalHours > 0 ? $totalHours : 0,
            ]);
        }

        $this->command->info('โ ุชู ุชุญุฏูุซ ูุฏุฉ ุฌููุน ุงูุฏูุฑุงุช ุจูุงุกู ุนูู ุงูุฏุฑูุณ.');
    }

    /**
     * ุชูููุฏ ุชุนููู ุฑุฆูุณู ูุงูุนู ุจุงูุนุฑุจูุฉ
     */
    private function generateRealisticArabicComment($lesson): string
    {
        $positive = [
            'ุดุฑุญ ููุชุงุฒ ูููููู! ุดูุฑุงู ูููุฏุฑุจ.',
            'ุงุณุชูุฏุช ูุซูุฑุงู ูู ูุฐุง ุงูุฏุฑุณ. ุดุฑุญ ูุงุถุญ ููุจุงุดุฑ.',
            'ุฃูุถู ุดุฑุญ ุณูุนุชู ูู ูุฐุง ุงูููุถูุน. ุดูุฑุงู ุฌุฒููุงู!',
            'ุงูุดุฑุญ ูุงุถุญ ููุจุงุดุฑ. ุฃุชููู ุงููุฒูุฏ ูู ุงูุฃูุซูุฉ ุงูุนูููุฉ.',
            'ูุนูููุงุช ูููุฉ ุฌุฏุงู. ูู ููุงู ูุตุงุฏุฑ ุฅุถุงููุฉ ุฃูุตุญ ุจูุงุ',
            'ุฏุฑุณ ููุชุงุฒ! ุงููุญุชูู ููุธู ูุณูู ุงูููู.',
            'ูููุช ุงูููุถูุน ุชูุงูุงู ุจูุถู ูุฐุง ุงูุดุฑุญ. ุดูุฑุงู!',
            'ุงูุชุทุจูู ุงูุนููู ุฑุงุฆุน. ูู ูููู ุฅุถุงูุฉ ุชูุงุฑูู ุฅุถุงููุฉุ',
            'ูุญุชูู ููุชุงุฒ ููููุฏ. ุฃุชุทูุน ููุฏุฑุณ ุงููุงุฏู!',
            'ุดุฑุญ ุงุญุชุฑุงูู. ูู ูููู ูุดุงุฑูุฉ ุงูููุฏ ุงููุณุชุฎุฏู ูู ุงูุฏุฑุณุ',
            'ุงุณุชูุฏุช ูุซูุฑุงู ูู ุงูุฃูุซูุฉ. ุดูุฑุงู ุนูู ุงููุฌููุฏ!',
            'ุงูุชูุธูู ููุชุงุฒ. ุณูู ุงูููู ุฌุฏุงู.',
            'ุฏุฑุณ ููู ููููุฏ. ุดูุฑุงู ูููุฏุฑุจ!',
            'ุฃุญุจุจุช ุงูุทุฑููุฉ ุงูุชู ุชู ุจูุง ุดุฑุญ ุงูููุถูุน.',
            'ุงูุดุฑุญ ุฏููู ููุงุถุญ. ุดูุฑุงู ุนูู ูุฐุง ุงููุฌููุฏ ุงูุฑุงุฆุน!',
        ];

        $questions = [
            'ูู ูููู ุชูุถูุญ ูุฐู ุงูููุทุฉ ุจูุฒูุฏ ูู ุงูุชูุตููุ',
            'ูุง ูู ุงููุฑู ุจูู ูุฐู ุงูุทุฑููุฉ ูุงูุทุฑููุฉ ุงูุฃุฎุฑู ุงูุชู ุฐูุฑุชูุง ุณุงุจูุงูุ',
            'ูู ููุงู ุทุฑููุฉ ุฃุฎุฑู ูุชูููุฐ ูุฐุง ุงูููุฏุ',
            'ูุชู ูุณุชุฎุฏู ูุฐู ุงูุฏุงูุฉ ุจุงูุถุจุทุ',
            'ูู ููููู ุฅุนุทุงุก ูุซุงู ุนููู ุนูู ุงุณุชุฎุฏุงู ูุฐุง ุงููููููุ',
            'ูุง ูู ุฃูุถู ุงูููุงุฑุณุงุช ุนูุฏ ุชุทุจูู ูุฐุง ุงูููุทุ',
            'ูู ูุฐุง ุงูุฃุณููุจ ูุนูู ูุน ุงูุฅุตุฏุงุฑุงุช ุงููุฏููุฉ ุฃูุถุงูุ',
            'ููู ูููู ุชุญุณูู ุฃุฏุงุก ูุฐุง ุงูููุฏุ',
            'ูู ููุงู ูุตุงุฏุฑ ุฅุถุงููุฉ ูููู ูุฐุง ุงูููุถูุน ุจุดูู ุฃุนููุ',
            'ูุง ูู ุงูุชุญุฏูุงุช ุงูุชู ูุฏ ุฃูุงุฌููุง ุนูุฏ ุชุทุจูู ูุฐุง ูู ูุดุฑูุน ุญููููุ',
        ];

        $appreciation = [
            'ุฃุญุณูุช! ุดุฑุญ ุฑุงุฆุน ูููุตู.',
            'ููุชุงุฒ! ูุฐุง ุจุงูุถุจุท ูุง ููุช ุฃุจุญุซ ุนูู.',
            'ุฑุงุฆุน! ุดูุฑูุง ุนูู ูุฐุง ุงููุญุชูู ุงูููู.',
            'ูุฐูู! ุงุณุชูุฏุช ุฃูุซุฑ ููุง ุชููุนุช.',
            'ุฃุจุฏุนุช! ุงูุดุฑุญ ุณูุณ ูููุชุน.',
            'ููุชุงุฒ ุฌุฏูุง! ุฃุชููู ุงููุฒูุฏ ูู ุงูุฏุฑูุณ ุจูุฐุง ุงููุณุชูู.',
            'ุฑุงุฆุน ุฌุฏูุง! ุดูุฑูุง ุนูู ููุชู ูุฌูุฏู.',
            'ููุชุงุฒ! ุงูุดุฑุญ ูุงุถุญ ูููููู.',
            'ุฃุญุณูุช! ุงููุญุชูู ููุชุงุฒ ููููุฏ.',
            'ุฑุงุฆุน! ูุฐุง ุงูุฏุฑุณ ุบูุฑ ูููููู ุชูุงููุง ููููุถูุน.',
        ];

        // 60% ุฅูุฌุงุจูุ 30% ุชูุฏูุฑุ 10% ุฃุณุฆูุฉ
        $type = rand(1, 10);
        if ($type <= 6) {
            return $positive[array_rand($positive)];
        } elseif ($type <= 9) {
            return $appreciation[array_rand($appreciation)];
        } else {
            return $questions[array_rand($questions)];
        }
    }

    /**
     * ุชูููุฏ ุฑุฏ ูุงูุนู ุจุงูุนุฑุจูุฉ
     */
    private function generateRealisticArabicReply($parentComment): string
    {
        $replies = [
            'ุดูุฑุงู ุนูู ุงูุณุคุงู! ุณุฃุดุฑุญ ูุฐู ุงูููุทุฉ ุจูุฒูุฏ ูู ุงูุชูุตูู ูู ุงูุฏุฑุณ ุงููุงุฏู.',
            'ูุนูุ ููููู ุงุณุชุฎุฏุงู ูุฐุง ุงูุฃุณููุจ ุฃูุถุงู. ููุงููุง ุตุญูุญ ููุนุชูุฏ ุนูู ุงูุณูุงู.',
            'ุงููุฑู ุงูุฑุฆูุณู ูู ูู ุงูุฃุฏุงุก. ูุฐุง ุงูุฃุณููุจ ุฃุณุฑุน ุจูุณุจุฉ 20% ูู ูุนุธู ุงูุญุงูุงุช.',
            'ุชูุงูุงู! ูุฐุง ูุง ููุช ุฃูุตุฏู. ุดูุฑุงู ุนูู ุงูููุงุญุธุฉ ุงูุฏูููุฉ.',
            'ููููู ุงุณุชุฎุฏุงู ูุฐู ุงูุฏุงูุฉ ุนูุฏูุง ุชุญุชุงุฌ ุฅูู ูุนุงูุฌุฉ ุงูุจูุงูุงุช ุงููุจูุฑุฉ ุฃู ุงููุชูุฑุฑุฉ.',
            'ุณุคุงู ููุชุงุฒ! ุงูุฌูุงุจ ูุนุชูุฏ ุนูู ููุน ุงูุจูุงูุงุช ุงูุชู ุชุนูู ุจูุง ูู ูุดุฑูุนู.',
            'ุฃุชูู ูุนู ุชูุงูุงู. ูุฐุง ุฃุณููุจ ุฌูุฏ ุฃูุถุงู ูููุตู ุจู ูู ุงููุดุงุฑูุน ุงููุจูุฑุฉ.',
            'ุดูุฑุงู ุนูู ุงููุดุงุฑูุฉ! ูุฐุง ูููุฏ ุฌุฏุงู ููุทูุงุจ ุงูุขุฎุฑูู ุงูุฐูู ููุฑุคูู ุงูุชุนูููุงุช.',
            'ูุนูุ ูุฐุง ุตุญูุญ. ุดูุฑุงู ุนูู ุงูุชูุถูุญ ุงูุฅุถุงูู.',
            'ุฌุฑุจ ูุฐุง ุงูุญู ูุณุชุฌุฏ ุฃูู ูุนูู ุจุดูู ุฃูุถู ูุน ุงูุจูุงูุงุช ุงููุนูุฏุฉ.',
            'ูุฐุง ูุนุชูุฏ ุนูู ุงูุญุงูุฉ. ูู ูุฐุง ุงูุณููุงุฑูู ุงููุญุฏุฏ ูุณุชุฎุฏู ุงูุทุฑููุฉ ุงูุฃููู.',
            'ุฃุญุณูุช! ูููุช ุงูููุฑุฉ ุชูุงูุงู ููุฐุง ูุฏู ุนูู ุชุฑููุฒู.',
            'ูุณุนุฏ ุจูุณุงุนุฏุชู! ุฅุฐุง ูุงู ูุฏูู ุฃู ุฃุณุฆูุฉ ุฃุฎุฑูุ ูุง ุชุชุฑุฏุฏ ูู ุทุฑุญูุง.',
            'ูุฐุง ููุถูุน ููู ุฌุฏุงู. ุณูุชูุงููู ุจุงูุชูุตูู ูู ุงูุฏุฑูุณ ุงููุงุฏูุฉ ุจุฅุฐู ุงููู.',
            'ุงูููุฏ ุงููุงูู ูุน ุงูุฃูุซูุฉ ูุชููุฑ ูู ูุณู ุงูููุงุฑุฏ ุชุญุช ุงูููุฏูู.',
            'ููููู ูุฑุงุฌุนุฉ ุงูุฏุฑุณ ุงูุณุงุจู ูููู ุงูุฃุณุงุณูุงุช ุจุดูู ุฃูุถู.',
            'ูุฐุง ุงูุณุคุงู ุดุงุฆุน ุฌุฏุงู! ุงูุฌูุงุจ ุงููุฎุชุตุฑ ูู...',
            'ุฃูุชุฑุญ ุนููู ุชุฌุฑุจุฉ ูุฐุง ุงูุญู ุฃููุงู ุซู ุงูุฑุฌูุน ุฅูู ุฅุฐุง ูุงุฌูุชู ุฃู ูุดููุฉ.',
            'ุงูุดุฑุญ ุงูุชูุตููู ููุฌูุฏ ูู ุงูุฏูุงุฆู 12-18 ูู ุงูููุฏูู.',
            'ุดูุฑุงู ุนูู ูุฐุง ุงูุชุนููู ุงูุจูุงุก! ุณุฃุญุฑุต ุนูู ุชุญุณูู ุงูุดุฑุญ ูู ุงูุฏุฑูุณ ุงููุงุฏูุฉ.',
        ];

        return $replies[array_rand($replies)];
    }
}
